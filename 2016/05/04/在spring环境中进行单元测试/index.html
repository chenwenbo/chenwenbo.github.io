<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>在spring环境中进行单元测试 | 尔东陈</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">在spring环境中进行单元测试</h1><a id="logo" href="/.">尔东陈</a><p class="description">但行好事，莫问前程。</p></div><div id="nav-menu"><a href="/." class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/time-line/"><i class="icon-archive"> time-line</i></a><a href="/about/"><i class="icon-about"> 关于</i></a><a href="/atom.xml"><i class="icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">在spring环境中进行单元测试</h1><div class="post-meta">2016-05-04 | </div><div class="post-content"><p>清单 5. AccountServiceOldTest.Java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> service; </div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.Junit.Assert.assertEquals; </div><div class="line"></div><div class="line"><span class="keyword">import</span> org.Junit.BeforeClass; </div><div class="line"><span class="keyword">import</span> org.Junit.Test; </div><div class="line"><span class="keyword">import</span> org.Springframework.context.ApplicationContext; </div><div class="line"><span class="keyword">import</span> org.Springframework.context.support.ClassPathXmlApplicationContext; </div><div class="line"></div><div class="line"><span class="keyword">import</span> domain.Account; </div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceOldTest</span> </span>&#123; </div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> AccountService service; </div><div class="line">       </div><div class="line">        <span class="meta">@BeforeClass</span> </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123; </div><div class="line">                ApplicationContext </div><div class="line">context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"config/Spring-db-old.xml"</span>); </div><div class="line">                service = (AccountService)context.getBean(<span class="string">"accountService"</span>); </div><div class="line">        &#125;      </div><div class="line">       </div><div class="line">        <span class="meta">@Test</span> </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetAcccountById</span><span class="params">()</span> </span>&#123; </div><div class="line">Account acct = Account.getAccount(<span class="number">1</span>, <span class="string">"user01"</span>, <span class="number">18</span>, <span class="string">"M"</span>); </div><div class="line">                Account acct2 = <span class="keyword">null</span>; </div><div class="line">                <span class="keyword">try</span> &#123; </div><div class="line">service.insertIfNotExist(acct); </div><div class="line">                        acct2 = service.getAccountById(<span class="number">1</span>); </div><div class="line">                        assertEquals(acct, acct2); </div><div class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123; </div><div class="line">                        fail(ex.getMessage()); </div><div class="line">                &#125; <span class="keyword">finally</span> &#123; </div><div class="line">                        service.removeAccount(acct); </div><div class="line">                &#125; </div><div class="line">&#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意上面的 Junit4 注释标签，第一个注释标签 @BeforeClass，用来执行整个测试类需要一次性初始化的环境，这里我们用 Spring 的 ClassPathXmlApplicationContext 从 XML 文件中加载了上面定义的 Spring 配置文件，并从中获得了 accountService 的实例。第二个注释标签 @Test 用来进行实际的测试。<br><br><br>测试过程：我们先获取一个 Account 实例对象，然后通过 service bean 插入数据库中，然后通过 getAccountById 方法从数据库再查询这个记录，如果能获取，则判断两者的相等性；如果相同，则表示测试成功。成功后，我们尝试删除这个记录，以利于下一个测试的进行，这里我们用了 try-catch-finally 来保证账号信息会被清除。<br><br><br>执行测试：（在 Eclipse 中，右键选择 AccountServiceOldTest 类，点击 Run as Junit test 选项），得到的结果如下：</p>
<h3 id="u6267_u884C_u6D4B_u8BD5_u7684_u7ED3_u679C"><a href="#u6267_u884C_u6D4B_u8BD5_u7684_u7ED3_u679C" class="headerlink" title="执行测试的结果"></a>执行测试的结果</h3><p>在 Eclipse 的 Junit 视图中，我们可以看到如下的结果：<br>图 2. 测试的结果对于这种不使用 Spring test 框架进行的单元测试，我们注意到，需要做这些工作：</p>
<ul>
<li>在测试开始之前，需要手工加载 Spring 的配置文件，并获取需要的 bean 实例</li>
<li>在测试结束的时候，需要手工清空搭建的数据库环境，比如清除您插入或者更新的数据，以保证对下一个测试没有影响</li>
</ul>
<p>另外，在这个测试类中，我们还不能使用 Spring 的依赖注入特性。一切都靠手工编码实现。好，那么我们看看 Spring test 框架能做到什么。<br>首先我们修改一下 Spring 的 XML 配置文件，删除 <context:annotation-config> 行，其他不变。<br>清单 6. Spring-db1.xml<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;beans xmlns=<span class="string">"http://www.Springframework.org/schema/beans"</span></div><div class="line">        xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">xsi:schemaLocation=<span class="string">"http://www.Springframework.org/schema/beans </span></div><div class="line">http://www.Springframework.org/schema/beans/Spring-beans-3.2.xsd"&gt; </div><div class="line">&lt;bean <span class="built_in">id</span>=<span class="string">"datasource"</span> </div><div class="line"><span class="built_in">class</span>=<span class="string">"org.Springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt; </div><div class="line">                &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"driverClassName"</span> value=<span class="string">"org.hsqldb.jdbcDriver"</span> /&gt; </div><div class="line">                &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"url"</span> value=<span class="string">"jdbc:hsqldb:hsql://localhost"</span> /&gt; </div><div class="line">                &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"username"</span> value=<span class="string">"sa"</span>/&gt; </div><div class="line">                &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"password"</span> value=<span class="string">""</span>/&gt; </div><div class="line">        &lt;/bean&gt; </div><div class="line">&lt;bean <span class="built_in">id</span>=<span class="string">"transactionManager"</span> </div><div class="line"><span class="built_in">class</span>=<span class="string">"org.Springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt; </div><div class="line">                &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"dataSource"</span> <span class="keyword">ref</span>=<span class="string">"datasource"</span>&gt;&lt;/<span class="keyword">property</span>&gt; </div><div class="line">        &lt;/bean&gt; </div><div class="line">        &lt;bean <span class="built_in">id</span>=<span class="string">"initer"</span> init-method=<span class="string">"init"</span> <span class="built_in">class</span>=<span class="string">"service.Initializer"</span>&gt; </div><div class="line">        &lt;/bean&gt; </div><div class="line">&lt;bean <span class="built_in">id</span>=<span class="string">"accountDao"</span> depends-<span class="keyword">on</span>=<span class="string">"initer"</span> <span class="built_in">class</span>=<span class="string">"DAO.AccountDao"</span>&gt; </div><div class="line">                &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"dataSource"</span> <span class="keyword">ref</span>=<span class="string">"datasource"</span>/&gt; </div><div class="line">        &lt;/bean&gt; </div><div class="line">        &lt;bean <span class="built_in">id</span>=<span class="string">"accountService"</span> <span class="built_in">class</span>=<span class="string">"service.AccountService"</span>&gt; </div><div class="line">        &lt;/bean&gt; </div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure></context:annotation-config></p>
<p>其中的 transactionManager 是 Spring test 框架用来做事务管理的管理器。<br>清单 7. AccountServiceTest1.Java<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> service; </div><div class="line"><span class="keyword">import</span> static org.Junit.Assert.assertEquals; </div><div class="line"></div><div class="line"><span class="keyword">import</span> org.Junit.Test; </div><div class="line"><span class="keyword">import</span> org.Junit.runner.RunWith; </div><div class="line"><span class="keyword">import</span> org.Springframework.beans.factory.<span class="keyword">annotation</span>.Autowired; </div><div class="line"><span class="keyword">import</span> org.Springframework.test.context.ContextConfiguration; </div><div class="line"><span class="keyword">import</span> org.Springframework.test.context.Junit4.SpringJUnit4ClassRunner; </div><div class="line"><span class="keyword">import</span> org.Springframework.transaction.<span class="keyword">annotation</span>.Transactional; </div><div class="line"></div><div class="line"><span class="keyword">import</span> domain.Account; </div><div class="line"></div><div class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span> </div><div class="line"><span class="meta">@ContextConfiguration(<span class="meta-string">"/config/Spring-db1.xml"</span>)</span> </div><div class="line"><span class="meta">@Transactional</span> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceTest1</span> </span>&#123; </div><div class="line">        <span class="meta">@Autowired</span> </div><div class="line">        <span class="keyword">private</span> AccountService service; </div><div class="line">       </div><div class="line">        <span class="meta">@Test</span> </div><div class="line">        <span class="keyword">public</span> void testGetAcccountById() &#123; </div><div class="line">Account acct = Account.getAccount(<span class="number">1</span>, <span class="string">"user01"</span>, <span class="number">18</span>, <span class="string">"M"</span>); </div><div class="line">                service.insertIfNotExist(acct); </div><div class="line">                Account acct2 = service.getAccountById(<span class="number">1</span>); </div><div class="line">                assertEquals(acct,acct2); </div><div class="line">        &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对这个类解释一下：</p>
<p><strong> @RunWith </strong> 注释标签是 Junit 提供的，用来说明此测试类的运行者，这里用了 SpringJUnit4ClassRunner，这个类是一个针对 Junit 运行环境的自定义扩展，用来标准化在 Spring 环境中 Junit4.5 的测试用例，例如支持的注释标签的标准化</p>
<p><strong> @ContextConfiguration </strong> 注释标签是 Spring test context 提供的，用来指定 Spring 配置信息的来源，支持指定 XML 文件位置或者 Spring 配置类名，这里我们指定 classpath 下的 /config/Spring-db1.xml 为配置文件的位置</p>
<p><strong> @Transactional </strong> 注释标签是表明此测试类的事务启用，这样所有的测试方案都会自动的 rollback，即您不用自己清除自己所做的任何对数据库的变更了</p>
<p><strong> @Autowired </strong> 体现了我们的测试类也是在 Spring 的容器中管理的，他可以获取容器的 bean 的注入，您不用自己手工获取要测试的 bean 实例了<br> testGetAccountById 是我们的测试用例：注意和上面的 AccountServiceOldTest 中相同的测试方法的对比，这里我们不用再 try-catch-finally 了，事务管理自动运行，当我们执行完成后，所有相关变更会被自动清除</p>
<p>执行结果在 Eclipse 的 Junit 视图中，我们可以看到如下的结果：<br>图 3. 执行结果小结如果您希望在 Spring 环境中进行单元测试，那么可以做如下配置：</p>
<ul>
<li><p>继续使用 Junit4 测试框架，包括其 @Test 注释标签和相关的类和方法的定义，这些都不用变</p>
</li>
<li><p>您需要通过 @RunWith(SpringJUnit4ClassRunner.class) 来启动 Spring 对测试类的支持</p>
</li>
<li><p>您需要通过 @ContextConfiguration 注释标签来指定 Spring 配置文件或者配置类的位置</p>
</li>
<li><p>您需要通过 @Transactional 来启用自动的事务管理</p>
</li>
<li><p>您可以使用 @Autowired 自动织入 Spring 的 bean 用来测试</p>
</li>
</ul>
<p>另外您不再需要：</p>
<ul>
<li><p>手工加载 Spring 的配置文件</p>
</li>
<li><p>手工清理数据库的每次变更</p>
</li>
<li><p>手工获取 application context 然后获取 bean 实例</p>
</li>
</ul>
<p>Spring 测试注释标签我们已经看到利用 Spring test framework 来进行基于 Junit4 的单元测试是多么的简单，下面我们来看一下前面遇到的各种注释标签的一些可选用法。</p>
<h3 id="@ContextConfiguration__u548C_@Configuration__u7684_u4F7F_u7528"><a href="#@ContextConfiguration__u548C_@Configuration__u7684_u4F7F_u7528" class="headerlink" title="@ContextConfiguration 和 @Configuration 的使用"></a>@ContextConfiguration 和 @Configuration 的使用</h3><p>刚才已经介绍过，可以输入 Spring xml 文件的位置，Spring test framework 会自动加载 XML 文件，得到 application context，当然也可以使用 Spring 3.0 新提供的特性 @Configuration，这个注释标签允许您用 Java 语言来定义 bean 实例，举个例子：</p>
<p>现在我们将前面定义的 Spring-db1.xml 进行修改，我们希望其中的三个 bean：initer、accountDao、accountService 通过配置类来定义，而不是 XML，则我们需要定义如下配置类：</p>
<p>注意：如果您想使用 @Configuration，请在 classpath 中加入 cglib 的 jar 包（cglib-nodep-2.2.3.jar），否则会报错。<br><br>清单 8. SpringDb2Config.Java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> config; </div><div class="line"></div><div class="line"><span class="keyword">import</span> org.Springframework.beans.factory.annotation.Autowired; </div><div class="line"><span class="keyword">import</span> org.Springframework.context.annotation.Bean; </div><div class="line"><span class="keyword">import</span> org.Springframework.context.annotation.Configuration; </div><div class="line"><span class="keyword">import</span> org.Springframework.jdbc.datasource.DriverManagerDataSource; </div><div class="line"></div><div class="line"><span class="keyword">import</span> service.AccountService; </div><div class="line"><span class="keyword">import</span> service.Initializer; </div><div class="line"><span class="keyword">import</span> DAO.AccountDao; </div><div class="line"></div><div class="line"><span class="meta">@Configuration</span> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringDb2Config</span> </span>&#123; </div><div class="line">        <span class="keyword">private</span> <span class="meta">@Autowired</span> DriverManagerDataSource datasource; </div><div class="line">        <span class="meta">@Bean</span> </div><div class="line">        <span class="function"><span class="keyword">public</span> Initializer <span class="title">initer</span><span class="params">()</span> </span>&#123; </div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Initializer(); </div><div class="line">        &#125; </div><div class="line">       </div><div class="line">        <span class="meta">@Bean</span> </div><div class="line">        <span class="function"><span class="keyword">public</span> AccountDao <span class="title">accountDao</span><span class="params">()</span> </span>&#123; </div><div class="line">AccountDao DAO = <span class="keyword">new</span> AccountDao(); </div><div class="line">DAO.setDataSource(datasource); </div><div class="line"><span class="keyword">return</span> DAO; </div><div class="line">        &#125; </div><div class="line">       </div><div class="line">        <span class="meta">@Bean</span> </div><div class="line">        <span class="function"><span class="keyword">public</span> AccountService <span class="title">accountService</span><span class="params">()</span> </span>&#123; </div><div class="line"><span class="keyword">return</span> <span class="keyword">new</span> AccountService(); </div><div class="line">        &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意上面的注释标签：</p>
<p><strong> @Configuration </strong> ：表明这个类是一个 Spring 配置类，提供 Spring 的 bean 定义，实际效果等同于 XML 配置方法<br><br><strong> @Bean </strong>：表明这个方法是一个 bean 的定义，缺省情况下，方法名称就是 bean 的 Id<br><br><strong> @Autowired </strong>：这个 datasource 采用自动注入的方式获取</p>
<p>注意，我们采用的是 XML+config bean 的方式进行配置，这种方式比较符合实际项目的情况。相关的 Spring 配置文件也要做变化，如下清单所示：<br>清单 9. Spring-db2.xml<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;beans xmlns=<span class="string">"http://www.Springframework.org/schema/beans"</span></div><div class="line">        xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">xmlns:context=<span class="string">"http://www.Springframework.org/schema/context"</span></div><div class="line">xsi:schemaLocation=<span class="string">"http://www.Springframework.org/schema/beans </span></div><div class="line">http://www.Springframework.org/schema/beans/Spring-beans-3.0.xsd </div><div class="line">http://www.Springframework.org/schema/context </div><div class="line">http://www.Springframework.org/schema/context/Spring-context-3.0.xsd"&gt; </div><div class="line">&lt;context:annotation-config/&gt; </div><div class="line">&lt;bean <span class="built_in">id</span>=<span class="string">"datasource"</span> </div><div class="line"><span class="built_in">class</span>=<span class="string">"org.Springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt; </div><div class="line">                &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"driverClassName"</span> value=<span class="string">"org.hsqldb.jdbcDriver"</span> /&gt; </div><div class="line">                &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"url"</span> value=<span class="string">"jdbc:hsqldb:hsql://localhost"</span> /&gt; </div><div class="line">                &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"username"</span> value=<span class="string">"sa"</span>/&gt; </div><div class="line">                &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"password"</span> value=<span class="string">""</span>/&gt; </div><div class="line">        &lt;/bean&gt; </div><div class="line">&lt;bean <span class="built_in">id</span>=<span class="string">"transactionManager"</span> </div><div class="line">         <span class="built_in">class</span>=<span class="string">"org.Springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt; </div><div class="line">                &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"dataSource"</span> <span class="keyword">ref</span>=<span class="string">"datasource"</span>&gt;&lt;/<span class="keyword">property</span>&gt; </div><div class="line">        &lt;/bean&gt; </div><div class="line">       </div><div class="line">        &lt;bean <span class="built_in">class</span>=<span class="string">"config.SpringDb2Config"</span>/&gt; </div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure></p>
<p>注意里面的 context 命名空间的定义，如代码中黑体字所示。另外还必须有 <context:annotaiton-config> 的定义，这个定义允许采用注释标签的方式来控制 Spring 的容器，最后我们看到 beans 已经没有 initer、accountDao 和 accountService 这些 bean 的定义，取而代之的是一个 SpringDb2Config bean 的定义，注意这个 bean 没有名称，因为不需要被引用。<br><br><br>现在有了这些配置，我们的测试类只要稍稍修改一下，即可实现加载配置类的效果，如下：<br><br> <figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">ContextConfiguration</span>("/<span class="keyword">config</span>/<span class="keyword">Spring</span>-<span class="keyword">db2</span>.<span class="keyword">xml</span>")</div></pre></td></tr></table></figure></context:annotaiton-config></p>
<p>通过上面的配置，测试用例就可以实现加载 Spring 配置类，运行结果也是成功的 green bar。</p>
<h3 id="@DirtiesContext"><a href="#@DirtiesContext" class="headerlink" title="@DirtiesContext"></a>@DirtiesContext</h3><p>缺省情况下，Spring 测试框架一旦加载 applicationContext 后，将一直缓存，不会改变，但是，<br>由于 Spring 允许在运行期修改 applicationContext 的定义，例如在运行期获取 applicationContext，然后调用 registerSingleton 方法来动态的注册新的 bean，这样的情况下，如果我们还使用 Spring 测试框架的被修改过 applicationContext，则会带来测试问题，我们必须能够在运行期重新加载 applicationContext，这个时候，我们可以在测试类或者方法上注释：@DirtiesContext，作用如下：</p>
<ul>
<li>如果定义在类上（缺省），则在此测试类运行完成后，重新加载 applicationContext</li>
<li>如果定义在方法上，即表示测试方法运行完成后，重新加载 applicationContext</li>
</ul>
<h3 id="@TransactionConfiguration__u548C_@Rollback"><a href="#@TransactionConfiguration__u548C_@Rollback" class="headerlink" title="@TransactionConfiguration 和 @Rollback"></a>@TransactionConfiguration 和 @Rollback</h3><p>缺省情况下，Spring 测试框架将事务管理委托到名为 transactionManager 的 bean 上，如果您的事务管理器不是这个名字，那需要指定 transactionManager 属性名称，还可以指定 defaultRollback 属性，缺省为 true，即所有的方法都 rollback，您可以指定为 false，这样，在一些需要 rollback 的方法，指定注释标签 @Rollback（true）即可。</p>
<p>###对 Junit4 的注释标签支持</p>
<p>看了上面 Spring 测试框架的注释标签，我们来看看一些常见的基于 Junit4 的注释标签在 Spring 测试环境中的使用方法。</p>
<h3 id="@Test_28expected_3D_u2026_29"><a href="#@Test_28expected_3D_u2026_29" class="headerlink" title="@Test(expected=…)"></a>@Test(expected=…)</h3><p>此注释标签的含义是，这是一个测试，期待一个异常的发生，期待的异常通过 xxx.class 标识。例如，我们修改 AccountService.Java 的 insertIfNotExist 方法，对于传入的参数如果为空，则抛出 IllegalArgumentException，如下：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">insertIfNotExist</span><span class="params">(Account account)</span> </span>&#123; </div><div class="line">        <span class="keyword">if</span>(account==<span class="keyword">null</span>) </div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"account is null"</span>); </div><div class="line">        Account acct = accountDao.getAccountById(account.getId()); </div><div class="line">        <span class="keyword">if</span>(acct==<span class="keyword">null</span>) &#123; </div><div class="line">                log.debug(<span class="string">"No "</span>+account+<span class="string">" found,would insert it."</span>); </div><div class="line">                accountDao.saveAccount(account); </div><div class="line">        &#125; </div><div class="line">        acct = <span class="keyword">null</span>; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后，在测试类中增加一个测试异常的方法，如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">Test</span>(<span class="keyword">expected</span>=<span class="keyword">IllegalArgumentException</span>.<span class="keyword">class</span>) </div><div class="line">public void testInsertException() &#123; </div><div class="line">        <span class="selector-tag">service</span><span class="selector-class">.insertIfNotExist</span>(<span class="selector-tag">null</span>); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行结果是 green bar。</p>
<h3 id="@Test_28timeout_3D_u2026_29"><a href="#@Test_28timeout_3D_u2026_29" class="headerlink" title="@Test(timeout=…)"></a>@Test(timeout=…)</h3><p>可以给测试方法指定超时时间（毫秒级别），当测试方法的执行时间超过此值，则失败。<br>比如在 AccountService 中增加如下方法：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomeHugeJob</span><span class="params">()</span> </span>&#123; </div><div class="line">        <span class="keyword">try</span> &#123; </div><div class="line">                Thread.sleep(<span class="number">2</span>*<span class="number">1000</span>); </div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; </div><div class="line">        &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上述方法模拟任务执行时间 2 秒，则测试方法如下：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">Test</span>(<span class="keyword">timeout</span>=<span class="keyword">3000</span>) </div><div class="line">public void testHugeJob() &#123; </div><div class="line">        <span class="selector-tag">service</span><span class="selector-class">.doSomeHugeJob</span>(); </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上述测试方法期待 service.doSomeHugeJob 方法能在 3 秒内结束，执行测试结果是 green bar。</p>
<h3 id="@Repeat"><a href="#@Repeat" class="headerlink" title="@Repeat"></a>@Repeat</h3><p>通过 @Repeat，您可以轻松的多次执行测试用例，而不用自己写 for 循环，使用方法：<br><br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@Repeat</span>(<span class="number">3</span>) </div><div class="line"><span class="variable">@Test</span>(expected=IllegalArgumentException.class) </div><div class="line">public void testInsertException() &#123; </div><div class="line">        <span class="selector-tag">service</span><span class="selector-class">.insertIfNotExist</span>(null); </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样，testInsertException 就能被执行 3 次</p>
</div><div class="tags"></div><div class="post-nav"><a href="/2016/05/04/mybatis学习笔记/" class="pre"><i class="icon-previous">mybatis学习笔记</i></a><a href="/2016/05/04/软件测试种类/" class="next">软件测试种类<i class="icon-next"></i></a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程/">编程</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/JAVA/" style="font-size: 15px;">JAVA</a> <a href="/tags/SVN/" style="font-size: 15px;">SVN</a> <a href="/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/tags/习惯养成计划第一期/" style="font-size: 15px;">习惯养成计划第一期</a> <a href="/tags/java/" style="font-size: 15px;">java</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/11/16/freemarker-expression-list/">freemarker_expression_list</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/16/《精进》学习笔记/">《精进》学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/14/mokito-annotations/">mokito_annotations</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/09/vim中宏的使用方法/">vim中宏的使用方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/01/面试中应该弄清楚的问题/">面试中应该弄清楚的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/30/git-rebase/">git_rebase</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/06/Java-Equals-HashCode/">Java hashCode & equals</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/29/Java类和对象的初始化/">Java类和对象的初始化</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/21/Java成员变量和局部变量/">Java成员变量和局部变量</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/13/web-exception-handle/">web_exception_handle</a></li></ul></div><div class="widget"><div class="widget-title">友情链接</div><ul></ul><a href="http://weibo.com/2316099870" title="微博" target="_blank">微博</a><ul></ul><a href="https://www.zhihu.com/people/chen-wen-bo-21" title="知乎" target="_blank">知乎</a><ul></ul><a href="https://github.com/chenwenbo" title="github" target="_blank">github</a></div></div></div></div><div id="footer">© <a href="/." rel="nofollow">尔东陈.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js"></script>
<script src="/js/totop.js"></script><script src="/js/fancybox.pack.js"></script>
<script src="/js/jquery.fancybox.js"></script><link rel="stylesheet" href="/css/jquery.fancybox.css"></div></body></html>